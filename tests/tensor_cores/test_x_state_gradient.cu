//
// Created by gkarthik on 3/20/24.
//

#include <iostream>
#include <cuda.h>
#include <cuda_runtime.h>
#include <cmath>
#include "../../libhmsbeagle/GPU/kernels/BeagleTensorCore_kernels.h"

#define NPATTERNS 9

#define CONCAT(a, b) CONCAT_INNER(a, b)
#define CONCAT_INNER(a, b) a ## _ ## b

#define GET_VAR_NAME(VAR) CONCAT(VAR, STATE_SIZE)

#define KERNEL_STRING CONCAT(KERNELS_STRING_DP, STATE_SIZE)

double partials0_32[] = {0.137572756735608,0.477254124591127,0.428745979443192,0.218426858074963,0.529428300447762,0.110051316907629,0.000466231256723404,0.912552231224254,0.472219149814919,0.928942704107612,0.560180699685588,0.217537123244256,0.697977353585884,0.623952043708414,0.675538737559691,0.843222103314474,0.76400274084881,0.591380735160783,0.0867352730128914,0.312990725738928,0.919490295927972,0.0556804281659424,0.998402643017471,0.319914712803438,0.296712961047888,0.624379327753559,0.213062767172232,0.704862492857501,0.678167796228081,0.306897013215348,0.115929287159815,0.345252481522039,0.171484304359183,0.910957986721769,0.605051992693916,0.492110440973192,0.734387687640265,0.861899997806177,0.0267023013439029,0.81252319784835,0.893445293651894,0.492366940248758,0.810089304111898,0.553071563132107,0.516520336735994,0.398585179122165,0.20619093766436,0.213295208988711,0.533830840839073,0.641580438474193,0.641749007627368,0.897068358259276,0.747031036531553,0.0769652326125652,0.563018406974152,0.755363112082705,0.571261946111917,0.342558507109061,0.0823808622080833,0.813371741678566,0.151293008821085,0.438190689310431,0.72727356175892,0.573656269814819,0.393597504589707,0.679693433456123,0.630720920395106,0.477773699676618,0.794161439174786,0.920099690789357,0.14259623340331,0.918399778660387,0.797960416181013,0.223208515672013,0.337408584076911,0.595907015958801,0.408401794498786,0.879316197242588,0.901337102754042,0.450537153985351,0.976062251254916,0.604110538261011,0.12144289421849,0.474900588393211,0.290287630166858,0.921070343349129,0.60355495242402,0.0305468174628913,0.113916693255305,0.31057606684044,0.822229250101373,0.771471065236256,0.00988956517539918,0.968395621748641,0.325942003400996,0.226024675648659,0.508032009005547,0.123930135508999,0.177139563253149,0.724984495667741,0.706222620094195,0.0127231408841908,0.365355732152238,0.60371356504038,0.516315210144967,0.760148837929592,0.370095229707658,0.628959023626521,0.903288466390222,0.964264541631564,0.0849116563331336,0.6964776085224,0.315820572897792,0.43656695750542,0.393638591980562,0.201540424488485,0.980606746859848,0.812868080567569,0.331884663784876,0.0567129889968783,0.64746700366959,0.275905444985256,0.679056051187217,0.328735176008195,0.461084913928062,0.120893164770678,0.887389402138069,0.787690743105486,0.215690065873787,0.417877751169726,0.505209180293605,0.109504214255139,0.215643964707851,0.613798390841112,0.892485237214714,0.2576886175666,0.0606364493723959,0.111651831073686,0.280793581856415,0.758666697191074,0.413830738281831,0.854117072420195,0.919762952951714,0.860510608647019,0.111273069633171,0.312961756950244,0.276002017082646,0.0909885228611529,0.137828417355195,0.573645500000566,0.161041960818693,0.162538499105722,0.909748927922919,0.379346132976934,0.460670878645033,0.759706819197163,0.846515485318378,0.157768455101177,0.328805885277689,0.258527430240065,0.89664980978705,0.676123560406268,0.108917369972914,0.264909128425643,0.286480097332969,0.0269577864091843,0.168712296988815,0.443927489453927,0.221304720267653,0.249940284760669,0.467076243599877,0.710354400565848,0.853199324337766,0.628960237838328,0.0745642578694969,0.444442495005205,0.386966095305979,0.683338846080005,0.676019790582359,0.847096533048898,0.344486658694223,0.449674704810604,0.926093189045787,0.861886711092666,0.806297490606084,0.346351227723062,0.478216581745073,0.11124969413504,0.559330552816391,0.857829656684771,0.831761313835159,0.447112224064767,0.716015653684735,0.984061450930312,0.58574992371723,0.2598866680637,0.543080188101158,0.10727199097164,0.541114681400359,0.170521292136982,0.118281150003895,0.31730785430409,0.532492249272764,0.483280170243233,0.63764462666586,0.772713868878782,0.410720963031054,0.0645942266564816,0.292021109955385,0.51998663903214,0.41073261317797,0.937489192467183,0.259160534013063,0.441533446311951,0.280123416567221,0.914793610572815,0.811726356623694,0.406274161767215,0.591114843962714,0.367744660237804,0.73461561370641,0.869902628473938,0.900811135303229,0.601420860504732,0.395293549168855,0.908687156857923,0.69545996049419,0.120823735604063,0.9918538632337,0.640957244671881,0.75858091772534,0.80457973270677,0.824953213101253,0.534380110679194,0.720628055976704,0.636435834690928,0.870369489304721,0.401107599260285,0.83021926227957,0.885718118865043,0.917369844159111,0.295915369177237,0.747915989486501,0.365953202592209,0.528050177264959,0.0095066458452493,0.757672343635932,0.143500643782318,0.579608463682234,0.574356644880027,0.277633252553642,0.607462874380872,0.622744806809351,0.754816305357963,0.795112589839846,0.438439338700846,0.743924727896228,0.140190641162917,0.288887683534995,0.264605762902647,0.122080560773611,0.724836751120165,0.84867433202453,0.762627893127501,0.917682103114203,0.359546375693753,0.188715582247823,0.8014108275529,0.857353747123852,0.418221303028986,0.734854450915009,0.216555546503514,0.684809597674757,0.576117270393297,0.0815740732941777,0.815891305683181,0.99180680164136,0.854911123169586,0.837502709589899,0.504932993324474,0.48982768249698,0.990796928061172,0.522266319952905,0.629406787687913,0.978855797089636,0.842430704040453,0.420844321837649,0.512064413633198,0.318755098618567,0.740407602395862,0.874102377332747,0.690571578918025,0.701961038634181,0.795170336496085,0.348821813939139,0.719763568369672,0.895593842957169,0.0806103076320142,0.0329403523355722,0.594381110742688,0.359542798716575,0.0881143372971565,0.649336193455383,0.699423802085221,0.194982040207833,0.0281000500544906,0.771264882525429,0.364646208938211,0.0918229892849922,0.936870703473687,0.37309667118825,0.0921725274529308,0.159810511628166,0.626376076601446,0.692677799146622,0.207317036110908,0.970800938550383,0.101070829667151,0.944739747559652,0.842726089060307,0.207157449331135,0.9937439779751,0.821067644748837,0.698300351854414,0.782907243119553,0.973109148675576,0.77274006837979,0.618896092521027,0.300635955762118,0.499129123752937,0.656451256712899,0.900395354721695,0.56438325252384,0.860600786982104,0.49170877225697,0.889088666066527,0.0156871858052909,0.81213018624112,0.977085781516507,0.295148188248277,0.726798894582316,0.916058843955398,0.608332335250452,0.93036122340709,0.740293311886489,0.477501145098358,0.528508115326986,0.359984828624874,0.115733818151057,0.162383440183476,0.599637272302061,0.727882955456153,0.674989679362625,0.862724364968017,0.736116931773722,0.934994351351634,0.225678282091394,0.0690643971320242,0.642801651265472,0.0847296256106347,0.11830615834333,0.203358805505559,0.326086097629741,0.730495651019737,0.29963503475301,0.561327135190368,0.0538779601920396,0.904581440845504,0.807041098363698,0.0369221286382526,0.676678945310414,0.814023691928014,0.651314357761294,0.901343589415774,0.429449937539175,0.628918903879821,0.0323536104988307,0.718082484090701,0.4828297609929,0.284520726883784,0.997801034012809,0.577156581915915,0.48068075068295,0.720765815814957,0.403965384466574,0.170624090125784,0.876439346699044,0.593427885789424,0.769376888172701,0.647851618006825,0.337206641677767,0.408452160190791,0.0607802064623684,0.676360174780712,0.462037036195397,0.347813759464771,0.946434140671045,0.604583449661732,0.742167289135978,0.0429284807760268,0.626676751766354,0.64561746106483,0.673989933682606,0.662993856705725,0.856125113321468,0.870688743656501,0.308341189753264,0.538020107662305,0.538775310153142,0.258829150116071,0.407576418248937,0.0590927223674953,0.520942375296727,0.434115749085322,0.340059822658077,0.17571780225262,0.53029696107842,0.975732607766986,0.831993991043419,0.983791405102238,0.55990690854378,0.710094312205911,0.0787766603752971,0.589558490784839,0.673550385283306,0.673261155607179,0.974599071079865,0.340651801321656,0.0923955119214952,0.194945273222402,0.141258440678939,0.639831262873486,0.339301661355421,0.884930776199326,0.289516024757177,0.126225155545399,0.446420934982598,0.0850053902249783,0.395572019508108,0.157721624244004,0.929064428433776,0.875803815200925,0.36426582490094,0.161793374456465,0.387928539188579,0.59461420099251,0.174750925740227,0.115827345522121,0.152487984858453,0.035088024334982,0.983126569306478,0.575697488617152,0.209149486385286,0.201207815203816,0.110956045333296,0.0174690247513354,0.775130218127742,0.497412796830758,0.443602121900767,0.0095906644128263,0.198237520409748,0.304748482536525,0.518023134209216,0.547018625540659,0.526118801673874,0.493327406002209,0.913669281871989,0.077805265551433,0.929841819219291,0.29471311555244,0.118532110471278,0.14501806977205,0.436429607449099,0.205097107682377,0.708817657083273,0.452689809259027,0.0368115562014282,0.239382016705349,0.471294831018895,0.290052818134427,0.141418197192252,0.406050314893946,0.123278650688007,0.793885040329769,0.803798166336492,0.653874792391434,0.570221147732809,0.238239917438477,0.29717841069214,0.753295891918242,0.86618359782733,0.0173538792878389,0.262981676263735,0.870678049977869,0.235948005225509,0.518082186812535,0.80484891217202,0.0546407853253186,0.849502737633884,0.749514716677368,0.744097977643833,0.543421939015388,0.416765965521336,0.725398944690824,0.33459063549526,0.478168275207281,0.308823636500165,0.518112531863153,0.0382656576111913,0.569260101066902,0.542835577391088,0.786958181066439,0.191143112257123,0.756994087249041,0.930127918720245,0.0538773911539465,0.108583583729342,0.0136260520666838,0.0493806877639145,0.0609419206157327,0.157695269677788,0.351834069937468,0.396392825525254,0.179786366643384,0.822698512114584,0.391177944373339,0.0950508427340537,0.0245800712145865,0.28290240559727,0.772152968682349,0.14831333537586,0.672689846949652,0.826513405656442,0.395902422023937,0.837914811447263,0.927084936527535,0.0562630859203637,0.810627286788076,0.67597354692407,0.622439709492028,0.0950460624881089,0.0380097457673401,0.166366128250957,0.867308233864605,0.152587173972279,0.90546303242445,0.75321610760875,0.112411572597921,0.319399437168613,0.881422396516427,0.113144566770643,0.477837181417271,0.535477821948007,0.530091674299911,0.681372025283054,0.861829367699102,0.411172383697703,0.66783166397363,0.776245636167005,0.627932568080723,0.909631920279935,0.457648938987404,0.327060131588951,0.410454506287351,0.118607676122338,0.622353270417079,0.0753363925032318,0.944582849508151,0.862267594784498,0.723776995902881,0.733439112547785,0.82846219977364,0.408146504312754,0.431808863533661,0.573833869770169,0.199921248713508};
double matrices0_32[] = {0.318755098618567, 0.740407602395862, 0.874102377332747, 0.690571578918025, 0.701961038634181, 0.795170336496085, 0.348821813939139, 0.719763568369672, 0.895593842957169, 0.0806103076320142, 0.0329403523355722, 0.594381110742688, 0.359542798716575, 0.0881143372971565, 0.649336193455383, 0.699423802085221, 0.194982040207833, 0.0281000500544906, 0.771264882525429, 0.364646208938211, 0.0918229892849922, 0.936870703473687, 0.37309667118825, 0.0921725274529308, 0.159810511628166, 0.626376076601446, 0.692677799146622, 0.207317036110908, 0.970800938550383, 0.101070829667151, 0.944739747559652, 0.842726089060307, 0.207157449331135, 0.9937439779751, 0.821067644748837, 0.698300351854414, 0.782907243119553, 0.973109148675576, 0.77274006837979, 0.618896092521027, 0.300635955762118, 0.499129123752937, 0.656451256712899, 0.900395354721695, 0.56438325252384, 0.860600786982104, 0.49170877225697, 0.889088666066527, 0.0156871858052909, 0.81213018624112, 0.977085781516507, 0.295148188248277, 0.726798894582316, 0.916058843955398, 0.608332335250452, 0.93036122340709, 0.740293311886489, 0.477501145098358, 0.528508115326986, 0.359984828624874, 0.115733818151057, 0.162383440183476, 0.599637272302061, 0.727882955456153, 0.674989679362625, 0.862724364968017, 0.736116931773722, 0.934994351351634, 0.225678282091394, 0.0690643971320242, 0.642801651265472, 0.0847296256106347, 0.11830615834333, 0.203358805505559, 0.326086097629741, 0.730495651019737, 0.29963503475301, 0.561327135190368, 0.0538779601920396, 0.904581440845504, 0.807041098363698, 0.0369221286382526, 0.676678945310414, 0.814023691928014, 0.651314357761294, 0.901343589415774, 0.429449937539175, 0.628918903879821, 0.0323536104988307, 0.718082484090701, 0.4828297609929, 0.284520726883784, 0.997801034012809, 0.577156581915915, 0.48068075068295, 0.720765815814957, 0.403965384466574, 0.170624090125784, 0.876439346699044, 0.593427885789424, 0.769376888172701, 0.647851618006825, 0.337206641677767, 0.408452160190791, 0.0607802064623684, 0.676360174780712, 0.462037036195397, 0.347813759464771, 0.946434140671045, 0.604583449661732, 0.742167289135978, 0.0429284807760268, 0.626676751766354, 0.64561746106483, 0.673989933682606, 0.662993856705725, 0.856125113321468, 0.870688743656501, 0.308341189753264, 0.538020107662305, 0.538775310153142, 0.258829150116071, 0.407576418248937, 0.0590927223674953, 0.520942375296727, 0.434115749085322, 0.340059822658077, 0.17571780225262, 0.53029696107842, 0.975732607766986, 0.831993991043419, 0.983791405102238, 0.55990690854378, 0.710094312205911, 0.0787766603752971, 0.589558490784839, 0.673550385283306, 0.673261155607179, 0.974599071079865, 0.340651801321656, 0.0923955119214952, 0.194945273222402, 0.141258440678939, 0.639831262873486, 0.339301661355421, 0.884930776199326, 0.289516024757177, 0.126225155545399, 0.446420934982598, 0.0850053902249783, 0.395572019508108, 0.157721624244004, 0.929064428433776, 0.875803815200925, 0.36426582490094, 0.161793374456465, 0.387928539188579, 0.59461420099251, 0.174750925740227, 0.115827345522121, 0.152487984858453, 0.035088024334982, 0.983126569306478, 0.575697488617152, 0.209149486385286, 0.201207815203816, 0.110956045333296, 0.0174690247513354, 0.775130218127742, 0.497412796830758, 0.443602121900767, 0.0095906644128263, 0.198237520409748, 0.304748482536525, 0.518023134209216, 0.547018625540659, 0.526118801673874, 0.493327406002209, 0.913669281871989, 0.077805265551433, 0.929841819219291, 0.29471311555244, 0.118532110471278, 0.14501806977205, 0.436429607449099, 0.205097107682377, 0.708817657083273, 0.452689809259027, 0.0368115562014282, 0.239382016705349, 0.471294831018895, 0.290052818134427, 0.141418197192252, 0.406050314893946, 0.123278650688007, 0.793885040329769, 0.803798166336492, 0.653874792391434, 0.570221147732809, 0.238239917438477, 0.29717841069214, 0.753295891918242, 0.86618359782733, 0.0173538792878389, 0.262981676263735, 0.870678049977869, 0.235948005225509, 0.518082186812535, 0.80484891217202, 0.0546407853253186, 0.849502737633884, 0.749514716677368, 0.744097977643833, 0.543421939015388, 0.416765965521336, 0.725398944690824, 0.33459063549526, 0.478168275207281, 0.308823636500165, 0.518112531863153, 0.0382656576111913, 0.569260101066902, 0.542835577391088, 0.786958181066439, 0.191143112257123, 0.756994087249041, 0.930127918720245, 0.0538773911539465, 0.108583583729342, 0.0136260520666838, 0.0493806877639145, 0.0609419206157327, 0.157695269677788, 0.351834069937468, 0.396392825525254, 0.179786366643384, 0.822698512114584, 0.391177944373339, 0.0950508427340537, 0.0245800712145865, 0.28290240559727, 0.772152968682349, 0.14831333537586, 0.672689846949652, 0.826513405656442, 0.395902422023937, 0.837914811447263, 0.927084936527535, 0.0562630859203637, 0.810627286788076, 0.67597354692407, 0.622439709492028, 0.0950460624881089, 0.0380097457673401, 0.166366128250957, 0.867308233864605, 0.152587173972279, 0.90546303242445, 0.75321610760875, 0.112411572597921, 0.319399437168613, 0.881422396516427, 0.113144566770643, 0.477837181417271, 0.535477821948007, 0.530091674299911, 0.681372025283054, 0.861829367699102, 0.411172383697703, 0.66783166397363, 0.776245636167005, 0.627932568080723, 0.909631920279935, 0.457648938987404, 0.327060131588951, 0.410454506287351, 0.118607676122338, 0.622353270417079, 0.0753363925032318, 0.944582849508151, 0.862267594784498, 0.723776995902881, 0.733439112547785, 0.82846219977364, 0.408146504312754, 0.431808863533661, 0.573833869770169, 0.199921248713508, 0.887613411294296, 0.454567750915885, 0.96897287084721, 0.00281271454878151, 0.674557421822101, 0.774027382023633, 0.0470388829708099, 0.213983570458367, 0.226589619880542, 0.363205091794953, 0.221769912401214, 0.477605888620019, 0.768164816545323, 0.667208151891828, 0.8446420871187, 0.472549902508035, 0.658454613760114, 0.426890162052587, 0.222666480811313, 0.371945802588016, 0.0541235357522964, 0.00575049966573715, 0.661997943650931, 0.0274860723875463, 0.781357249477878, 0.179425817681476, 0.146155055146664, 0.74522982374765, 0.0148732336238027, 0.421976636396721, 0.071747130015865, 0.376591018168256, 0.797460894100368, 0.922664157114923, 0.0440589087083936, 0.371352839516476, 0.942564790835604, 0.0969958088826388, 0.98415376082994, 0.432970190420747, 0.366067794151604, 0.935578790027648, 0.635364551329985, 0.0477927140891552, 0.891904118005186, 0.869811427546665, 0.519086515763775, 0.212525648530573, 0.345439849421382, 0.9794830174651, 0.998820274369791, 0.510031000478193, 0.282825540285558, 0.490046667633578, 0.216909394366667, 0.120391379343346, 0.0362199896480888, 0.938790585612878, 0.764535018010065, 0.0660519956145436, 0.757532791933045, 0.085836544400081, 0.239479305455461, 0.746965360129252, 0.383896808605641, 0.183139169821516, 0.650613932637498, 0.438710586400703, 0.703661621548235, 0.441353030269966, 0.678050716174766, 0.569670646218583, 0.446077849017456, 0.373866642592475, 0.426477298606187, 0.831044988706708, 0.271720573073253, 0.788296253420413, 0.956953576300293, 0.398318805731833, 0.959916688501835, 0.428930512629449, 0.391359190223739, 0.129514818545431, 0.257661419687793, 0.162711132783443, 0.630930761806667, 0.556308034807444, 0.817913965322077, 0.618934637401253, 0.142858244245872, 0.924706954043359, 0.665935100521892, 0.175157265271991, 0.91741870297119, 0.377479332964867, 0.915473969886079, 0.416010931134224, 0.851188083179295, 0.482620244612917, 0.19575294922106, 0.930207984289154, 0.897255460498855, 0.0509287735912949, 0.16385965491645, 0.497507116291672, 0.295118942623958, 0.48945991252549, 0.0609245153609663, 0.391077576205134, 0.922298759222031, 0.238671106519178, 0.0334792505018413, 0.491717858240008, 0.0475604562088847, 0.160704178968444, 0.580940369516611, 0.665732654975727, 0.898841686313972, 0.19907441874966, 0.706881220685318, 0.227971374755725, 0.420975056942552, 0.525182365905493, 0.76859695580788, 0.180232860147953, 0.360386987915263, 0.0355239394120872, 0.279621819965541, 0.492628782521933, 0.00429112860001624, 0.729822016786784, 0.265117973554879, 0.00819552130997181, 0.557190095772967, 0.910967865260318, 0.334832005901262, 0.775266358163208, 0.333300480153412, 0.316029489738867, 0.777909284923226, 0.182907553389668, 0.120656934799626, 0.474330106284469, 0.112300934968516, 0.661110842367634, 0.483244087779894, 0.120484308572486, 0.538943104678765, 0.188809546176344, 0.144213865976781, 0.148477270966396, 0.36497721192427, 0.0911591711919755, 0.49575153272599, 0.776461983798072, 0.271833615144715, 0.662494543939829, 0.92957073985599, 0.864967247238383, 0.346549167996272, 0.248159773414955, 0.0794379266444594, 0.104665609076619, 0.636909784981981, 0.53797256317921, 0.0664008532185107, 0.860007540555671, 0.364109267480671, 0.346319438889623, 0.598295152653009, 0.108527328120545, 0.51558287255466, 0.372404548339546, 0.0439500140491873, 0.387348645366728, 0.799132984597236, 0.347668831702322, 0.0148774858098477, 0.621873839292675, 0.962958646705374, 0.264025011798367, 0.542733704904094, 0.100726007018238, 0.748652840266004, 0.998633818002418, 0.272976807318628, 0.977885314961895, 0.244037905242294, 0.445993867469952, 0.181268157670274, 0.575945840915665, 0.14289187034592, 0.329236012650654, 0.80588909634389, 0.86023065331392, 0.859983401373029, 0.341971888206899, 0.72596702282317, 0.104668560437858, 0.364093453856185, 0.0961447078734636, 0.471836182754487, 0.315123851876706, 0.675662054680288, 0.410306565230712, 0.302729092771187, 0.0379808295983821, 0.362969816895202, 0.136089659994468, 0.233284370740876, 0.27462186361663, 0.951606031041592, 0.145361286820844, 0.690991062438115, 0.91126251523383, 0.967120831366628, 0.496867969864979, 0.792319520609453, 0.586245380342007, 0.319085008464754, 0.596799817169085, 0.386072663124651, 0.094545308733359, 0.841198849491775, 0.725724069168791, 0.260602075373754, 0.0401021423749626, 0.557100543286651, 0.667296157451347, 0.392193721141666, 0.390019047539681, 0.243348302785307, 0.312083947705105, 0.330803585937247, 0.0684272006619722, 0.220975440228358, 0.893441342981532, 0.230344030540437, 0.46223779511638, 0.786161849508062, 0.381003314396366, 0.4269117009826, 0.744903380284086, 0.12632815237157, 0.767876285826787, 0.346038619056344, 0.600480383029208, 0.566567625384778, 0.911307808710262, 0.124551766784862, 0.897330066654831, 0.03710320382379, 0.865535496734083, 0.375480690971017, 0.587874088436365, 0.704045646125451, 0.709872165462002, 0.160226090345532, 0.57931962958537, 0.262899972731248, 0.60321207344532, 0.83130986825563, 0.720483851851895, 0.0891349397134036, 0.392792160855606, 0.730999719817191, 0.968460410134867, 0.733835875056684, 0.934013072634116, 0.773451789747924, 0.664742107037455, 0.851598515175283, 0.521398665616289, 0.28287104703486, 0.0241556512191892, 0.277137958444655, 0.154525948455557, 0.248121402226388, 0.753965218085796, 0.256163287907839, 0.254053090699017, 0.142002253560349, 0.102058607153594, 0.583798894193023, 0.218530154787004, 0.273211892461404, 0.892807124648243, 0.95655925385654, 0.164144072448835, 0.180072232149541, 0.613443094771355, 0.581600941950455, 0.213690056232736, 0.109174828510731, 0.791451416444033, 0.813269312027842, 0.942091584438458, 0.144850598881021, 0.0144414354581386, 0.67699415050447, 0.0289523873943835, 0.347021585330367, 0.166391085833311, 0.627529887715355, 0.337954384274781, 0.946496285498142, 0.809197089169174, 0.599490417866036, 0.485322692897171, 0.626540524186566, 0.880922014592215, 0.791389791062102, 0.228736988268793, 0.0431775285396725, 0.658710181247443, 0.0981552652083337, 0.803452845197171, 0.447587450034916, 0.594876127550378, 0.933335849782452, 0.89333344087936, 0.34943274804391, 0.979001633822918, 0.73301282338798, 0.319463124964386, 0.460149798775092, 0.135376650840044, 0.212156835244969, 0.280731286620721, 0.71945658675395, 0.258857969194651, 0.159242485882714, 0.313170951325446, 0.509018544340506, 0.674590074224398, 0.766623704927042, 0.890107094077393, 0.753400478744879, 0.0565684379544109, 0.829331106971949, 0.986919787246734, 0.071853787638247, 0.312371033942327, 0.542667790316045, 0.553855512756854, 0.81713548861444, 0.733803061535582, 0.381960744271055, 0.423695077188313, 0.91058569191955, 0.0899565385188907, 0.771959060570225, 0.721628771396354, 0.989183023339137, 0.00332873081788421, 0.735854286467656, 0.915598744060844, 0.728580788476393, 0.267453148961067, 0.342836658004671, 0.198665955336764, 0.734235236188397, 0.654955295845866, 0.388616922544315, 0.746097426395863, 0.600707167061046, 0.953825746430084, 0.074386975960806, 0.338203680468723, 0.220258690183982, 0.141741932369769, 0.323508266126737, 0.357601806754246, 0.952136259060353, 0.718242306262255, 0.872919661225751, 0.878397844964638, 0.924705215962604, 0.867784458911046, 0.743089418625459, 0.73144056671299, 0.856617807876319, 0.466217181179672, 0.302974875550717, 0.747378953266889, 0.83152644126676, 0.732530116569251, 0.899540644139051, 0.611172407865524, 0.274133467813954, 0.182920687133446, 0.369401918025687, 0.727645715000108, 0.817405614769086, 0.630294714123011, 0.594887868501246, 0.752214959124103, 0.757286258740351, 0.375515910796821, 0.178772744024172, 0.229571665637195, 0.112459921743721, 0.85307931038551, 0.118634451879188, 0.965623450931162, 0.965111497789621, 0.544756171992049, 0.477399886352941, 0.41616382310167, 0.584112743381411, 0.668689417885616, 0.0662012794055045, 0.128568347776309, 0.310780746396631, 0.0485500886570662, 0.696584686869755, 0.336861748714, 0.63355187815614, 0.525085654808208, 0.752710361266509, 0.31528914696537, 0.406564011937007, 0.315067628864199, 0.876741543412209, 0.95643507828936, 0.689761403948069, 0.0580938996281475, 0.524834875715896, 0.859965648502111, 0.761953725712374, 0.809885409194976, 0.00539691257290542, 0.956111317500472, 0.239802360069007, 0.903301550308242, 0.583607438020408, 0.681128628784791, 0.862491914769635, 0.938954589189962, 0.851254163542762, 0.307446481194347, 0.468603403074667, 0.496829464565963, 0.274629210587591, 0.944203953957185, 0.447560959728435, 0.871657678624615, 0.51105371513404, 0.539376187603921, 0.0547705853823572, 0.678939103148878, 0.757241941988468, 0.540042083710432, 0.787175731500611, 0.576310960343108, 0.0705523632932454, 0.931838406948373, 0.775555139407516, 0.437784053152427, 0.972225036472082, 0.659646914806217, 0.679325693054125, 0.218150125350803, 0.605536248302087, 0.467030136846006, 0.726685181958601, 0.690597920212895, 0.20387312117964, 0.436375434976071, 0.19628684502095, 0.662282684352249, 0.763258282793686, 0.531206148909405, 0.202423069393262, 0.2252496778965, 0.91091392445378, 0.518574313959107, 0.730835595866665, 0.307149392319843, 0.240078909089789, 0.0200570572633296, 0.666871576337144, 0.440869592828676, 0.904499096563086, 0.0544064759742469, 0.291257924167439, 0.654546046862379, 0.833970257546753, 0.301845223177224, 0.0840903888456523, 0.110183613374829, 0.459279633127153, 0.575755519559607, 0.20353390625678, 0.0490862673614174, 0.592145875794813, 0.485698713222519, 0.875981888500974, 0.776119016343728, 0.0367344922851771, 0.7758764391765, 0.170036551775411, 0.29516760725528, 0.83584619848989, 0.530611721333116, 0.671271946281195, 0.789009454660118, 0.424915740266442, 0.00889054988510907, 0.904323845403269, 0.762093380792066, 0.177224905928597, 0.452012907713652, 0.423675562953576, 0.384808729868382, 0.65327710728161, 0.110327219357714, 0.932337339967489, 0.302763455081731, 0.303599824430421, 0.407885305117816, 0.0474210453685373, 0.758131679147482, 0.90588356461376, 0.170484730508178, 0.848539520520717, 0.532248513307422, 0.489992269780487, 0.210215653758496, 0.726004907861352, 0.42959459987469, 0.398929722839966, 0.509291885886341, 0.86307844473049, 0.45726556237787, 0.385920506669208, 0.54868997214362, 0.00787950493395329, 0.0292208709288388, 0.873380801873282, 0.198629488004372, 0.399476094637066, 0.982107850257307, 0.388491304125637, 0.821617706911638, 0.617576259654015, 0.630678800866008, 0.829925845144317, 0.637417324120179, 0.0478639779612422, 0.887903396273032, 0.927930071484298, 0.198481849627569, 0.0422894649673253, 0.151558594545349, 0.72613523923792, 0.0657610560301691, 0.143144130241126, 0.893720725085586, 0.113595361821353, 0.492557974299416, 0.35758897755295, 0.0618650016840547, 0.313278448535129, 0.651390804210678, 0.569452023366466, 0.413745638215914, 0.57277093292214, 0.872412286698818, 0.903958555776626, 0.226203902624547, 0.534152978099883, 0.289694492006674, 0.63860881398432, 0.619280552025884, 0.364679945632815, 0.806269636610523, 0.684381045866758, 0.353703865315765, 0.680437547154725, 0.333434764994308, 0.86395154078491, 0.709280596580356, 0.292406287509948, 0.286857396829873, 0.553403669502586, 0.111564433900639, 0.811068495502695, 0.16468235803768, 0.593992463080212, 0.411586156347767, 0.686072814976797, 0.613387235673144, 0.167472446570173, 0.511405270779505, 0.0157108204439282, 0.116989660542458, 0.416283306898549, 0.200678155757487, 0.235741645330563, 0.653671982465312, 0.56118715624325, 0.0559324263595045, 0.492295668227598, 0.381639490369707, 0.0910067649092525, 0.977409760700539, 0.0692099283915013, 0.415946318069473, 0.212197515647858, 0.697999411961064, 0.196279037045315, 0.771446153754368, 0.578967442503199, 0.829400165239349, 0.83939350838773, 0.859632262261584, 0.250165862496942, 0.933200485771522, 0.174274100689217, 0.849948034156114, 0.355492479866371, 0.539759787730873, 0.649525197921321, 0.330013146623969, 0.511803943663836, 0.94152497430332, 0.97023272770457, 0.277790386695415, 0.732969297328964, 0.106217114022002, 0.643966387957335, 0.0760978939943016, 0.552266235928982, 0.0468266836833209, 0.812633679946885, 0.247580500552431, 0.477369289845228, 0.725277590099722, 0.172804569592699, 0.129123904742301, 0.910691004013643, 0.763573322445154, 0.449092417722568, 0.631564155686647, 0.83584210742265, 0.500831536017358, 0.620142036583275, 7.36045185476542e-05, 0.556058232206851, 0.286591770127416, 0.790934702381492, 0.372107424307615, 0.655657382216305, 0.148340160259977, 0.709493486443534, 0.426354733528569, 0.597513518761843, 0.0679500568658113, 0.0701400111429393, 0.513920687139034, 0.445223399903625, 0.359411156037822, 0.0250460442621261, 0.782009624876082, 0.547425446100533, 0.00484179030172527, 0.0175384413450956, 0.531699115643278, 0.0704256233293563, 0.682425444945693, 0.801923443563282, 0.116425348911434, 0.312949022743851, 0.520182562293485, 0.372591530904174, 0.250347369350493, 0.854375223862007, 0.508443876868114, 0.902410588227212, 0.60670926142484, 0.291614870773628, 0.764984895708039, 0.275270455982536, 0.132017188938335, 0.495774961542338, 0.746418644208461, 0.24221326992847, 0.512473328271881, 0.0122081234585494, 0.268018338596448, 0.725883333710954, 0.42052434082143, 0.0989155832212418, 0.849613083526492, 0.860345292603597, 0.822771187638864, 0.574582633096725, 0.515689143212512, 0.215895464643836, 0.96554358350113, 0.414696100400761, 0.771700807614252, 0.663413499714807, 0.872575292829424, 0.304162473184988, 0.411278941435739, 0.238487572176382, 0.759690399514511, 0.58632699190639, 0.654348863754421, 0.429775210563093, 0.871870154747739, 0.94501926144585, 0.639986231923103, 0.753695314284414, 0.274677451467142, 0.99494822951965, 0.374420851701871, 0.0141002326272428, 0.353032978018746, 0.661765213357285, 0.732940542511642, 0.244729198981076, 0.876225500367582, 0.509052856592461, 0.567705040797591, 0.328902047360316, 0.286236892221496, 0.590877592330799, 0.0987129684071988, 0.256189337233081, 0.312844887375832, 0.910950841149315, 0.728276452049613};
double expectedOut_32[] = {17.86308, 15.4184, 17.41919, 15.16311, 17.19798, 18.53999, 16.06103, 18.18802, 15.8089};


int main() {
    char functionName[] = "kernelPartialsPartialsEdgeFirstDerivatives";
    CUmodule cudaModule;
    CUresult  res;
    cudaError_t err;

    cuInit(0);

    int numDevices;
    cuDeviceGetCount(&numDevices);
    std::cout << "Number of devices " << numDevices << std::endl;

    CUdevice cuDevice;
    res = cuDeviceGet(&cuDevice, 0);

    CUcontext context;
    res = cuCtxCreate(&context, 0, cuDevice);

    res = cuModuleLoadData(&cudaModule, KERNEL_STRING);

    CUfunction cudaFunction;

    res = cuModuleGetFunction(&cudaFunction, cudaModule, functionName);

    if(res != CUDA_SUCCESS) {
        std::cerr << "Error loading function " << functionName <<std::endl;
    } else {
        std::cerr << "Successfully loaded function " << functionName << " for state size " << STATE_SIZE << std::endl;
    }

    double *out, *partials0, *matrices0, *weightsDevice, *tmpAcc;
    int *instructionsDevice;
    int totalPatterns = NPATTERNS;
    unsigned int instructions[] = {0, STATE_SIZE * NPATTERNS, 0};
    int skip = 0;
    int categoryCount = 1;
    double weights[] = {1};

    double *resHost = (double*) malloc(sizeof(double) * STATE_SIZE * STATE_SIZE);

    cuMemAlloc((CUdeviceptr*)&out, sizeof(double) * NPATTERNS); // 8 is pattern block size
    cuMemAlloc((CUdeviceptr*)&partials0, sizeof(double) * STATE_SIZE * NPATTERNS * 2);
    cuMemAlloc((CUdeviceptr*)&matrices0, sizeof(double) * STATE_SIZE * STATE_SIZE);
    cuMemAlloc((CUdeviceptr*)&instructionsDevice, sizeof(int) * 3);
    cuMemAlloc((CUdeviceptr*)&weightsDevice, sizeof(double) * categoryCount);
    cuMemAlloc((CUdeviceptr*)&tmpAcc, sizeof(double) * STATE_SIZE * STATE_SIZE);

    cudaMemcpy(partials0, GET_VAR_NAME(partials0), sizeof(double) * STATE_SIZE * NPATTERNS * 2, cudaMemcpyHostToDevice);
    err = cudaMemcpy(matrices0, GET_VAR_NAME(matrices0), sizeof(double) * STATE_SIZE * STATE_SIZE, cudaMemcpyHostToDevice);
    std::cerr << "Memcpy matrices0 " << err << std::endl;

    cudaMemcpy(instructionsDevice, instructions, sizeof(int) * 3, cudaMemcpyHostToDevice);
    cudaMemcpy(weightsDevice, weights, sizeof(double) * categoryCount, cudaMemcpyHostToDevice);

    void *params[] = {
            &out, &partials0, &matrices0, &instructionsDevice, &weightsDevice, &tmpAcc, &skip, &totalPatterns, &categoryCount
    };

    res = cuLaunchKernel(cudaFunction, 2, 1, 1, STATE_SIZE, 4, 1, 0, NULL, params, NULL);

    cudaDeviceSynchronize();

    if(res != CUDA_SUCCESS) {
        std::cerr << "Error launching kernel " << functionName << ". Error code: " << res << std::endl;
    } else {
        std::cerr << "Successfully launched kernel " << functionName << " for state size " << STATE_SIZE << std::endl;
    }

    err = cudaMemcpy(resHost, tmpAcc, sizeof(double) * STATE_SIZE * NPATTERNS, cudaMemcpyDeviceToHost);
    std::cerr << "Memcpy tmpAcc " << err << std::endl;
    for(int j = 0; j< NPATTERNS; j++){
        std::cerr << j << ": ";
        for(int i = 0; i < STATE_SIZE; i++)
            std::cerr << resHost[j * STATE_SIZE + i] << ", ";
        std::cerr << std::endl << std::endl;
    }

    err = cudaMemcpy(resHost, out, sizeof(double) * NPATTERNS, cudaMemcpyDeviceToHost);
    std::cerr << "Memcpy out " << err << std::endl;

    double tolerance=1E-5;
    int pass = 0;
    for(int i = 0; i < NPATTERNS; i++){
        if(abs(GET_VAR_NAME(expectedOut)[i] - resHost[i]) > tolerance) {
            if(pass == 0)
                std::cerr << "Unequal values at positions " << std::endl;
            pass = -1;
            std::cerr << i << " Expected: " << GET_VAR_NAME(expectedOut)[i] << " Observed: " << resHost[i] << std::endl;
        }
    }

    if(pass != 0)
        std::cerr << std::endl << std::endl;

    if(pass == 0) {
        std::cerr << "PASS: Test for gradient kernel for state size " << STATE_SIZE << std::endl;
    } else {
        std::cerr << "FAIL: Test for gradient kernel for state size " << STATE_SIZE << std::endl;
    }
    cuModuleUnload(cudaModule);

    cudaFree(matrices0);
    cudaFree(partials0);
    cudaFree(instructionsDevice);
    cudaFree(weightsDevice);
    free(resHost);

    return pass;
}

